- name: Reset Old Cluster and del docker containers
  shell: |
    kubeadm reset --force
  when: criType == "docker"

- name: Reset Old Cluster and del crictl containers
  shell: |
    kubeadm reset --force --cri-socket /run/containerd/containerd.sock \
    && crictl stop $(crictl ps -a -q) && crictl rm $(crictl ps -a -q)
  when: criType == "containerd"

- name: Create dir for token file
  file:
    path: /opt/config
    state: directory

- name: Copy kubeadm config file with token
  copy:
    src: /tmp/k8s/master1/opt/config/
    dest: /opt/config/

- name: change kubeadmin init string
  shell: |
    sed -i 's/$/ --cri-socket \/run\/containerd\/containerd.sock/' token.txt
  args:
    chdir: /opt/config/
  when: criType == "containerd"

- name: pull images of k8s with the docker
  shell: |
    kubeadm config images pull
  when: criType == "docker"

- name: pull images of k8s with the crictl
  shell: |
    kubeadm config images pull --cri-socket-path /run/containerd/containerd.sock
  when: criType == "containerd"

- name: Kubeadm init worknode
  shell: |
    cat token.txt | bash
  args:
    chdir: /opt/config/


- name: restart CRI containerd
  systemd:
    name: containerd
    state: restarted
    enabled: yes
    daemon_reload: yes
  when:
    - criType == "containerd"
    - apiLoadBalancer == "true"

- name: restart CRI docker
  systemd:
    name: docker
    state: restarted
    enabled: yes
    daemon_reload: yes
  when:
    - criType == "docker"
    - apiLoadBalancer == "true"
