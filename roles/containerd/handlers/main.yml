---
- name: restart containerd
  ansible.builtin.service:
    name: containerd
    state: restarted
  register: containerd_restart_result

- name: Verify containerd is running after restart
  ansible.builtin.service_facts:
  register: services_state
  until: services_state.ansible_facts.services['containerd.service'].state == 'running'
  retries: 5
  delay: 2
  listen: restart containerd

- name: Verify containerd socket is available
  ansible.builtin.wait_for:
    path: /var/run/containerd/containerd.sock
    state: present
    timeout: 30
  listen: restart containerd
